"use strict";function getPerformance(){return window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance}var REPORT_TYPE,ACTION_TYPE,ERROR_TYPE,NETWORK_ERROR,getLanguage=function(){var e=navigator.languages||navigator.language||navigator.userLanguage;return Array.isArray(e)?e[0]:e},setDefault0=function(e,t){return e>0&&t>0?e-t:0},getPerformanceMetric=function(e,t){var r=getPerformance();if(!r)return 0;var n=r.timing;return setDefault0(n[e],n[t])},getStaticAttrs=function(e){switch(e.localName){case"script":return{url:e.src,async:e.async,defer:e.defer};case"link":return{url:e.href};case"img":return{url:e.src}}return{}},isError=function(e){return e instanceof Error},validateStatus=function(e){return e>=200&&e<300};!function(e){e.PERFORMANCE="performance",e.RESOURCE="resource",e.ERROR="error",e.INTERFACE="interface",e.UNKNOWN="unknown"}(REPORT_TYPE||(REPORT_TYPE={})),function(e){e[e.AUTO=0]="AUTO",e[e.MANUAL=1]="MANUAL",e.UNKNOWN="unknown"}(ACTION_TYPE||(ACTION_TYPE={})),function(e){e.JS_ERROR="js_error",e.RESOURCE_ERROR="resource_error",e.UNHANDLEDREJECTION="unhandledrejection",e.AJAX_ERROR="ajax_error",e.FETCH_ERROR="fetch_error"}(ERROR_TYPE||(ERROR_TYPE={})),function(e){e.REQUEST_ERROR="request_error",e.TIMEOUT="timout",e.ERROR="network_error",e.ABORT="abort",e.SLOW_API="slow_api"}(NETWORK_ERROR||(NETWORK_ERROR={}));var UNKNOWN="unknown";function report(e,t,r){void 0===t&&(t=UNKNOWN),void 0===r&&(r=ACTION_TYPE.AUTO);var n={app:"",href:location.href,language:getLanguage(),userAgent:navigator.userAgent,platform:navigator.platform,screenWidth:window.screen.width,screenHeight:window.screen.height,colorDepth:window.screen.colorDepth,referrer:document.referrer},o=Object.assign({reportType:t,actionType:r},n,e);console.log(o)}function monitorPerformance(){if(!monitorPerformance.installed){monitorPerformance.installed=!0;var e=getPerformance();e&&e.timing&&e.timing.loadEventEnd?report(t(),REPORT_TYPE.PERFORMANCE):window.addEventListener("load",(function(){report(t(),REPORT_TYPE.PERFORMANCE)}))}function t(){return{dns:getPerformanceMetric("domainLookupEnd","domainLookupStart"),tcp:getPerformanceMetric("connectEnd","connectStart"),ssl:getPerformanceMetric("connectEnd","secureConnectionStart"),ttfb:getPerformanceMetric("responseStart","requestStart"),trans:getPerformanceMetric("responseEnd","responseStart"),dom:getPerformanceMetric("domInteractive","responseEnd"),res:getPerformanceMetric("loadEventStart","domContentLoadedEventEnd"),firstbyte:getPerformanceMetric("responseStart","domainLookupStart"),fpt:getPerformanceMetric("responseEnd","fetchStart"),tti:getPerformanceMetric("domInteractive","fetchStart"),ready:getPerformanceMetric("domContentLoadEventEnd","fetchStart"),load:getPerformanceMetric("loadEventStart","fetchStart")}}}function formatError(e){if(!isError(e))return e;var t=e.column||e.columnNumber,r=e.line||e.lineNumber,n=e.message,o=e.name,a=e.stack,i={col:t,row:r,message:n,name:o,stack:a,scriptSrc:""};if(a){var s=a.match(/https?:\/\/[^\n]+/);if(s){var c=s[0],u=0,R=0,E=c.replace(/:(\d+):(\d+)/,(function(e,t,r){return u=t,R=r,""}));Object.assign(i,{col:Number(u||t),row:Number(R||r),scriptSrc:E})}}return i}function monitorError(){window.onerror=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0],n=e[1],o=e[2],a=e[3],i=e[4],s={};if(isError(i)){var c=formatError(i);s.message=c.message||r,s.url=c.scriptSrc||n,s.row=c.row||o,s.col=c.col||a,s.stack=c.stack,s.name=c.name}else s.message=r,s.url=n,s.row=o,s.col=a,s.stack="unknown stack",s.name="unknown error type",i&&(s.error=JSON.stringify(i));report(s,ERROR_TYPE.JS_ERROR)},window.addEventListener("error",(function(e){var t=e.target;if(t&&t!==window){var r={},n=t.localName;r.message=n+" load error",r.type=e.type,r.name=n,Object.assign(r,getStaticAttrs(t)),report(r,ERROR_TYPE.RESOURCE_ERROR)}}),!0),window.addEventListener("unhandledrejection",(function(e){var t=e&&e.reason,r={};if("object"!=typeof t)r.message=String(t)||"";else if(t instanceof Error){var n=formatError(t);r.message=n.message,r.url=n.scriptSrc,r.row=n.row,r.col=n.col,r.stack=n.stack,r.name=n.name}else r.message=JSON.stringify(t)}))}function reportAjaxError(e,t){var r=e.loaded,n=e.total,o=e.lengthComputable;report(Object.assign({type:ERROR_TYPE.AJAX_ERROR,subtype:t,loaded:r,total:n,lengthComputable:o}),REPORT_TYPE.INTERFACE)}function monitorAjax(){var e=XMLHttpRequest.prototype.send,t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return this._hooks={method:e[0],path:e[1]},t.apply(this,e)},XMLHttpRequest.prototype.send=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=(new Date).getTime(),o=this,a=o.onerror,i=o.ontimeout,s=o.onabort,c=o.onreadystatechange;return this.onreadystatechange=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this,o=r.readyState,a=r.DONE,i=r.status,s=r.responseURL,u=r.statusText;if(o===a&&0!==i&&s&&s.match(/^https?:\/\//)){var R=Object.assign({},this._hooks),E=(new Date).getTime()-n;validateStatus(i)?E>300&&(Object.assign(R,{duration:E,url:s,status:i,type:ERROR_TYPE.AJAX_ERROR,subtype:NETWORK_ERROR.SLOW_API}),report(R,REPORT_TYPE.INTERFACE)):(Object.assign(R,{duration:E,url:s,status:i,statusText:u,type:ERROR_TYPE.AJAX_ERROR,subtype:NETWORK_ERROR.REQUEST_ERROR}),report(R,REPORT_TYPE.INTERFACE))}"function"==typeof c&&c.apply(this,e)},this.onerror=function(e){reportAjaxError(e,NETWORK_ERROR.ERROR),"function"==typeof a&&a.call(this,e)},this.onabort=function(e){reportAjaxError(e,NETWORK_ERROR.ABORT),"function"==typeof s&&s.call(this,e)},this.ontimeout=function(e){reportAjaxError(e,NETWORK_ERROR.TIMEOUT),"function"==typeof i&&i.call(this,e)},e.apply(this,t)}}var STATIC_TAG=["script","link","img"],LABEL="resource";function getResourceTiming(e){var t=e.domainLookupEnd,r=e.domainLookupStart,n=e.connectEnd,o=e.connectStart,a=e.secureConnectionStart,i=e.responseStart,s=e.requestStart,c=e.responseEnd,u=e.fetchStart,R=e.duration,E=e.name;return{dns:setDefault0(t,r),tcp:setDefault0(n,o),ssl:setDefault0(n,a),ttfb:setDefault0(i,s),trans:setDefault0(c,i),fpt:setDefault0(c,u),duration:R.toFixed(0),url:E}}function getResourceMetric(e){return e.map((function(e){return getResourceTiming(e)}))}function reportResource(e){var t=e.getEntriesByType(LABEL).filter((function(e){return STATIC_TAG.indexOf(e.initiatorType)}));t.length>0&&report(getResourceMetric(t),REPORT_TYPE.RESOURCE)}function getEntryTypes(e){window.PerformanceObserver?new PerformanceObserver((function(e){reportResource(e)})).observe({entryTypes:[LABEL]}):window.addEventListener("load",(function(){reportResource(e)}))}function monitorResource(){var e=getPerformance();e&&e.timing&&e.timing.loadEventEnd?reportResource(e):getEntryTypes(e)}function Monitor(e){this.config=e}Monitor.prototype.use=function(e){var t=this._installedPlugins||(this._installedPlugins=[]);return t.indexOf(e)>-1?this:("function"==typeof e.install?e.install.call(null,this.config,this):"function"==typeof e?e.call(null,this.config,this):console.warn("plugin should be a function or an object with install method"),t.push(e),this)},window.__monitor__=function(e){return new Monitor(e).use(monitorPerformance).use(monitorError).use(monitorAjax).use(monitorResource)},module.exports=Monitor;
