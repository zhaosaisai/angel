!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).__ANGEL__=n()}(this,(function(){"use strict";function t(){return window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance}var n,e,r,o,a=function(){var t=navigator.languages||navigator.language||navigator.userLanguage;return Array.isArray(t)?t[0]:t},i=function(t,n){return t>0&&n>0?t-n:0},s=function(n,e){var r=t();if(!r)return 0;var o=r.timing;return i(o[n],o[e])},c=function(t){switch(t.localName){case"script":return{url:t.src,async:t.async,defer:t.defer};case"link":return{url:t.href};case"img":return{url:t.src}}return{}},u=function(t){return t instanceof Error},f=function(t){return t>=200&&t<300};!function(t){t.PERFORMANCE="performance",t.RESOURCE="resource",t.ERROR="error",t.INTERFACE="interface",t.UNKNOWN="unknown"}(n||(n={})),function(t){t[t.AUTO=0]="AUTO",t[t.MANUAL=1]="MANUAL",t.UNKNOWN="unknown"}(e||(e={})),function(t){t.JS_ERROR="js_error",t.RESOURCE_ERROR="resource_error",t.UNHANDLEDREJECTION="unhandledrejection",t.AJAX_ERROR="ajax_error",t.FETCH_ERROR="fetch_error"}(r||(r={})),function(t){t.REQUEST_ERROR="request_error",t.TIMEOUT="timout",t.ERROR="network_error",t.ABORT="abort",t.SLOW_API="slow_api"}(o||(o={}));var l="unknown";function d(t,n,r){void 0===n&&(n=l),void 0===r&&(r=e.AUTO);var o={app:"",href:location.href,language:a(),userAgent:navigator.userAgent,platform:navigator.platform,screenWidth:window.screen.width,screenHeight:window.screen.height,colorDepth:window.screen.colorDepth,referrer:document.referrer},i=Object.assign({reportType:n,actionType:r},o,t);console.log(i)}function p(){if(!p.installed){p.installed=!0;var e=t();e&&e.timing&&e.timing.loadEventEnd?d(r(),n.PERFORMANCE):window.addEventListener("load",(function(){d(r(),n.PERFORMANCE)}))}function r(){return{dns:s("domainLookupEnd","domainLookupStart"),tcp:s("connectEnd","connectStart"),ssl:s("connectEnd","secureConnectionStart"),ttfb:s("responseStart","requestStart"),trans:s("responseEnd","responseStart"),dom:s("domInteractive","responseEnd"),res:s("loadEventStart","domContentLoadedEventEnd"),firstbyte:s("responseStart","domainLookupStart"),fpt:s("responseEnd","fetchStart"),tti:s("domInteractive","fetchStart"),ready:s("domContentLoadEventEnd","fetchStart"),load:s("loadEventStart","fetchStart")}}}function E(t){if(!u(t))return t;var n=t.column||t.columnNumber,e=t.line||t.lineNumber,r=t.message,o=t.name,a=t.stack,i={col:n,row:e,message:r,name:o,stack:a,scriptSrc:""};if(a){var s=a.match(/https?:\/\/[^\n]+/);if(s){var c=s[0],f=0,l=0,d=c.replace(/:(\d+):(\d+)/,(function(t,n,e){return f=n,l=e,""}));Object.assign(i,{col:Number(f||n),row:Number(l||e),scriptSrc:d})}}return i}function m(){window.onerror=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var e=t[0],o=t[1],a=t[2],i=t[3],s=t[4],c={};if(u(s)){var f=E(s);c.message=f.message||e,c.url=f.scriptSrc||o,c.row=f.row||a,c.col=f.col||i,c.stack=f.stack,c.name=f.name}else c.message=e,c.url=o,c.row=a,c.col=i,c.stack="unknown stack",c.name="unknown error type",s&&(c.error=JSON.stringify(s));d(c,r.JS_ERROR)},window.addEventListener("error",(function(t){var n=t.target;if(n&&n!==window){var e={},o=n.localName;e.message=o+" load error",e.type=t.type,e.name=o,Object.assign(e,c(n)),d(e,r.RESOURCE_ERROR)}}),!0),window.addEventListener("unhandledrejection",(function(t){var n=t&&t.reason,e={};if("object"!=typeof n)e.message=String(n)||"";else if(n instanceof Error){var r=E(n);e.message=r.message,e.url=r.scriptSrc,e.row=r.row,e.col=r.col,e.stack=r.stack,e.name=r.name}else e.message=JSON.stringify(n)}))}function R(t,e){var o=t.loaded,a=t.total,i=t.lengthComputable;d(Object.assign({type:r.AJAX_ERROR,subtype:e,loaded:o,total:a,lengthComputable:i}),n.INTERFACE)}function g(){var t=XMLHttpRequest.prototype.send,e=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this._hooks={method:t[0],path:t[1]},e.apply(this,t)},XMLHttpRequest.prototype.send=function(){for(var e=[],a=0;a<arguments.length;a++)e[a]=arguments[a];var i=(new Date).getTime(),s=this,c=s.onerror,u=s.ontimeout,l=s.onabort,p=s.onreadystatechange;return this.onreadystatechange=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var a=this,s=a.readyState,c=a.DONE,u=a.status,l=a.responseURL,E=a.statusText;if(s===c&&0!==u&&l&&l.match(/^https?:\/\//)){var m=Object.assign({},this._hooks),R=(new Date).getTime()-i;f(u)?R>300&&(Object.assign(m,{duration:R,url:l,status:u,type:r.AJAX_ERROR,subtype:o.SLOW_API}),d(m,n.INTERFACE)):(Object.assign(m,{duration:R,url:l,status:u,statusText:E,type:r.AJAX_ERROR,subtype:o.REQUEST_ERROR}),d(m,n.INTERFACE))}"function"==typeof p&&p.apply(this,t)},this.onerror=function(t){R(t,o.ERROR),"function"==typeof c&&c.call(this,t)},this.onabort=function(t){R(t,o.ABORT),"function"==typeof l&&l.call(this,t)},this.ontimeout=function(t){R(t,o.TIMEOUT),"function"==typeof u&&u.call(this,t)},t.apply(this,e)}}var h=["script","link","img"],w="resource";function v(t){return t.map((function(t){return e=(n=t).domainLookupEnd,r=n.domainLookupStart,o=n.connectEnd,a=n.connectStart,s=n.secureConnectionStart,c=n.responseStart,u=n.requestStart,f=n.responseEnd,l=n.fetchStart,d=n.duration,p=n.name,{dns:i(e,r),tcp:i(o,a),ssl:i(o,s),ttfb:i(c,u),trans:i(f,c),fpt:i(f,l),duration:d.toFixed(0),url:p};var n,e,r,o,a,s,c,u,f,l,d,p}))}function O(t){var e=t.getEntriesByType(w).filter((function(t){return h.indexOf(t.initiatorType)}));e.length>0&&d(v(e),n.RESOURCE)}function y(){var n=t();n&&n.timing&&n.timing.loadEventEnd?O(n):function(t){window.PerformanceObserver?new PerformanceObserver((function(t){O(t)})).observe({entryTypes:[w]}):window.addEventListener("load",(function(){O(t)}))}(n)}function S(t){this.config=t}return S.prototype.use=function(t){var n=this._installedPlugins||(this._installedPlugins=[]);return n.indexOf(t)>-1?this:("function"==typeof t.install?t.install.call(null,this.config,this):"function"==typeof t?t.call(null,this.config,this):console.warn("plugin should be a function or an object with install method"),n.push(t),this)},window.__monitor__=function(t){return new S(t).use(p).use(m).use(g).use(y)},S}));
